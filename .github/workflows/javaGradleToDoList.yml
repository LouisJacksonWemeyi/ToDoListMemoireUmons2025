name: CI/CD Gradle ToDoList

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]         # push d'un tag vX.Y.Z => release auto
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (format vMAJOR.MINOR.PATCH)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

env:
  PROJECT_DIR: todo-list-java-gradle   # adapte si ton projet n'est pas dans ce sous-dossier

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 🛡️ Validation du wrapper avec retry (réseau parfois instable)
      # WRetry permet de relancer une action GitHub (et pas seulement une commande shell)
      - name: Validate Gradle Wrapper (with retry)
        uses: Wandalen/wretry.action@v3
        with:
          action: gradle/wrapper-validation-action@v2
          attempt_limit: 3
          attempt_delay: 30000      # 30s entre tentatives
          with: |
            min-wrapper-count: 1
            allow-snapshots: false

      # 🔁 Fallback local si la validation échoue (ne bloque pas le CI pour souci réseau)
      - name: Fallback local wrapper sanity check (if validation failed)
        if: failure()
        run: |
          set -e
          echo "::warning::Wrapper validation failed remotely; running local sanity checks."
          test -f "$PROJECT_DIR/gradle/wrapper/gradle-wrapper.jar"
          grep -E '^distributionUrl=https://services\.gradle\.org/distributions/gradle-[0-9.]+-bin\.zip' \
            "$PROJECT_DIR/gradle/wrapper/gradle-wrapper.properties" >/dev/null
        continue-on-error: true

      - name: Set up Java 24 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'
          cache: 'gradle'

      - name: Setup Gradle (cache, develocity)
        uses: gradle/actions/setup-gradle@v3

      - name: Build & Test (JUnit 5.10.2)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          ./gradlew --version
          ./gradlew clean test jar --console=plain

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-jars
          path: ${{ env.PROJECT_DIR }}/build/libs/*.jar
          if-no-files-found: error

  release:
    name: Create Tag & GitHub Release
    needs: build-test
    if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const inputVer = core.getInput('version') || '';
            let version = inputVer;
            if (!version && context.ref && context.ref.startsWith('refs/tags/')) {
              version = context.ref.replace('refs/tags/','');
            }
            if (!version) core.setFailed('Aucune version fournie et ce n’est pas un push de tag.');
            if (!/^v\d+\.\d+\.\d+(-[0-9A-Za-z.-]+)?$/.test(version)) {
              core.setFailed(`Version invalide: ${version}. Format attendu: vMAJOR.MINOR.PATCH`);
            }
            core.setOutput('version', version);

      - name: Create tag if needed (workflow_dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.resolve.outputs.version }}';
            const sha = context.sha;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${version}`
              });
              core.setFailed(`Le tag ${version} existe déjà.`);
            } catch (e) {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${version}`,
                sha
              });
              core.info(`Créé le tag ${version} -> ${sha}`);
            }

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-jars
          path: release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.version }}
          name: ${{ steps.resolve.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release/*.jar
