name: CI/CD Gradle ToDoList

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]        # Si vous poussez un tag vX.Y.Z, la release part automatiquement
  pull_request:
    branches: [ main ]
  workflow_dispatch:       # Lancement manuel d'une release
    inputs:
      version:
        description: 'Version tag (format vMAJOR.MINOR.PATCH)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write          # nécessaire pour créer tag + release

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # JDK 24 Temurin
      - name: Set up Java 24 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'
          cache: 'gradle'

      # Active la télémetrie/cache Gradle et support du wrapper
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # (Optionnel) Valide le wrapper si présent
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Build & Test (JUnit 5.10.2)
        run: |
          ./gradlew --version
          ./gradlew clean test jar --console=plain

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-jars
          path: build/libs/*.jar
          if-no-files-found: error

  release:
    name: Create Tag & GitHub Release
    needs: build-test
    # On ne lance le job release que si: déclenché manuellement OU push d’un tag
    if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Résoudre la version à utiliser: input 'version' (workflow_dispatch) OU ref du tag (push tag)
      - name: Resolve version
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const inputVer = core.getInput('version') || '';
            let version = inputVer;
            if (!version && context.ref && context.ref.startsWith('refs/tags/')) {
              version = context.ref.replace('refs/tags/','');
            }
            if (!version) {
              core.setFailed('Aucune version fournie et ce n’est pas un push de tag.');
              return;
            }
            if (!/^v\d+\.\d+\.\d+(-[0-9A-Za-z.-]+)?$/.test(version)) {
              core.setFailed(`Version invalide: ${version}. Format attendu: vMAJOR.MINOR.PATCH`);
              return;
            }
            core.setOutput('version', version);

      # Si lancement manuel: créer le tag vX.Y.Z sur le commit courant (échoue si déjà existant)
      - name: Create tag if needed (workflow_dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.resolve.outputs.version }}';
            const sha = context.sha;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${version}`,
              });
              core.setFailed(`Le tag ${version} existe déjà.`);
            } catch (e) {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${version}`,
                sha,
              });
              core.info(`Créé le tag ${version} -> ${sha}`);
            }

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-jars
          path: release

      # Crée la Release GitHub et attache tous les JARs construits
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.version }}
          name: ${{ steps.resolve.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release/*.jar
